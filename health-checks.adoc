== Health Checks for Your Containers

Thanks to the health check mechanisms built into Kubernetes, OpenShift inherits a powerful way to make sure your app is running and responding. These
check are over and above a container dying, which just automatically gets
redeployed by OpenShift. Health checks are for the case where the pod is up
and running but it is not actually "working" the way you intended.

There are two basic types of health checks in OpenShift

1. A **liveness probe** - is the pod running and responding. If it is not then
the cluster will kill and respawn the pod

2. A **readiness probe** - is the server in the pod ready to respond to requests. If it is not then the cluster will not route requests to it and not continue with the deployment

The **readiness probe** is helpful because it can prevent requests being sent to
the pod until the pod is actually ready to serve content. This can be a problem
with servers that take longer to become ready to serve content, such as some
of the larger JavaEE servers or with a large database cluster.

These checks can use HTTP responses, socket connections, or executing a command
in the running container.

With the HTTP GET check, the cluster expects a HTTP response
code from 200 up to 399 for a live or ready pod. For a socket connection, the cluster just needs to be able to make a connection on the given port.

With socket connection it just needs to connect to the socket it to be considered alive or ready.

For a command it expects the command to return a 0, otherwise the pod is considered dead or not ready.

You can read more about these checks in the
https://docs.openshift.com/enterprise/3.0/dev_guide/application_health.html[OpenShift documentation].

Let's go ahead and define each of these checks for our NGINX pod.

=== Liveness Check

If there is already a good check built into your Docker container, then
defining the check can be quite easy. In our example we could consider if we
get a 200 from the root URL then it is alive.

Let's try that first.

Go to the web UI, on the left side pick Applications, and then choose Deployments:

image::common/7_browse_deployments.png[]

You will then see a list with one deployment, go ahead and select it. You are
now looking at the details for your deployment. In the top left there is an
actions button, go ahead and select it, and then choose "Edit Health Checks"

image::common/7_edit_health.png[]

On the landing page you see a nice description for each of the probe types.
Let's go ahead and click on the link for "Add Liveness Probe". This will add a
form to the page that allows us to define a liveness probe.

Set the initial delay to 2 seconds. Then click "Save".

image::common/7_live_http.png[]

Now go back to the Overview page for your project. You will see a new pod come
up and then the old one go down. You will also the deployment number increment,
since we forced a new deployment.

Go ahead and click on the pod and go to it's detailed view. This time click on
the "Events" tab on the detail page. You will see some interesting information.

image::common/7_failed_http.png[]

Our liveness check is failing. And after it fails for a while, OpenShift says
"This is broken, I am not going to try and deploy this anymore". If you go back
to the overview page eventually you can see that the circle has turned red meaning there is an error.

image::common/7_crashed_http.png[]

NOTE: Can you guess why this isn't working even though NGINX is running. We gave
you a hint at the end of the last exercise. We will answer this in class.

Let's go ahead and fix the liveness probe. Go back to the "Edit Health Checks"
page that I showed you above. Change the probe type to "TCP Socket". Go ahead
and click save. You will see that the pod gets redeployed and then it comes up
blue and stays blue this time.

=== Readiness Check

Now that we have configured a liveness check let's go ahead and set up a
readiness check. Again navigate back to the health checks configuration page.
Go ahead and set up a readiness check. With a web application, ready means
we can serve up the web pages we want, not just connect to a port.

image::common/7_ready_http.png[]

Once you click save, if you go back to the overview you will see a new
deployment kick off but then the screen will stay like this for a while:

image::common/7_ready_stuck.png[]

If you wait five minutes, the new deployment will go away and we will stay with
the old pod. OpenShift won't continue the deployment until the new pod is ready
to serve content. The same problem from above is the reason we are also failing
here.

To fix this and watch the deployment go through, just add content like you did in the previous exercise. Make sure to click on the pod that hasn't deployed yet when choosing a pod for the _echo_ command.

=== Conclusion

Given the current configuration of our Docker container image, we could take
advantage of the liveness check but not the readiness check. With your own
images you make, knowing these checks are available should help you in crafting
an image that can take full advantage of the platform.
